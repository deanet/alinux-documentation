<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <meta http-equiv="Content-Language" content="en"/>
    <title>Replicate Master to Master MySQL</title>
    <link rel="stylesheet" href="/style.css" type="text/css" media="screen"/>
    <link rel="stylesheet" href="/syntax.css" type="text/css" media="screen"/>
</head>

<script type="text/javascript">
        var disqus_awesome = ; 
        var disqus_developer = ;
</script>    

<body>
    <div class="outercolumn">
        <div class="topbar">
            <a href="/index.html">Home</a> - <a href="/archives/index.html">archive</a>
        </div>

        <div class="column">
            <div class="content">
                

<div class="title">
    Replicate Master to Master MySQL
</div>

<div class="date">
<!--    

    published: 16 Aug 2011,
    in category: <a href="/archives/ReplicateMySQLMaster.html">ReplicateMySQLMaster</a>
-->
    in category: 
<a rel="tag" href="/archives/Replicate.html">Replicate</a>, 

<a rel="tag" href="/archives/MySQL.html">MySQL</a>, 

<a rel="tag" href="/archives/Master.html">Master</a>, 



</div>

<div class="innercontent">
    <h2 id='preparation'>Preparation</h2>

<ol>
<li>Master 1, srv14: 111.68.112.43</li>

<li>Master 2, srv15: 111.68.112.44</li>
</ol>

<p>Install mysql server on both server. look at <a href='/2011/08/14/compiling-mysql-5.5.12-with-cmake-on-centos.html'>previous post</a> for this section.</p>

<h2 id='configuration'>Configuration</h2>

<h3 id='master_1'>Master 1</h3>
<script src='https://gist.github.com/1144636.js?file=mm-1.my.cnf' type='text/javascript'>
</script>
<h3 id='master_2'>Master 2</h3>
<script src='https://gist.github.com/1144636.js?file=mm-2.my.cnf' type='text/javascript'>
</script>
<h2 id='setup_replication'>Setup Replication</h2>

<h3 id='setup_master_1'>Setup Master 1</h3>
<div class='highlight'><pre><code class='bash'>root@srv14 init.d# mysql -u root -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or <span class='se'>\g</span>.
Your MySQL connection id is 36
Server version: 5.5.12-log Source distribution

Copyright <span class='o'>(</span>c<span class='o'>)</span> 2000, 2010, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span class='s1'>&#39;help;&#39;</span> or <span class='s1'>&#39;\h&#39;</span> <span class='k'>for </span>help. Type <span class='s1'>&#39;\c&#39;</span> to clear the current input statement.

mysql&gt; create user <span class='s1'>&#39;mysqlchkuser&#39;</span>@<span class='s1'>&#39;localhost&#39;</span> identified by <span class='s1'>&#39;mysql321&#39;</span>;

mysql&gt; create user <span class='s1'>&#39;mmm_monitor&#39;</span>@<span class='s1'>&#39;%&#39;</span> identified by <span class='s1'>&#39;monitor_password&#39;</span>;
Query OK, 0 rows affected <span class='o'>(</span>0.06 sec<span class='o'>)</span>

mysql&gt; create user <span class='s1'>&#39;agent_monitor&#39;</span>@<span class='s1'>&#39;%&#39;</span> identified by <span class='s1'>&#39;agent_password&#39;</span>;
Query OK, 0 rows affected <span class='o'>(</span>0.00 sec<span class='o'>)</span>


mysql&gt; create user <span class='s1'>&#39;replication&#39;</span>@<span class='s1'>&#39;%&#39;</span> identified by <span class='s1'>&#39;replication_password&#39;</span>;
Query OK, 0 rows affected <span class='o'>(</span>0.00 sec<span class='o'>)</span>

mysql&gt; GRANT REPLICATION CLIENT ON *.* TO <span class='s1'>&#39;mmm_monitor&#39;</span>@<span class='s1'>&#39;%&#39;</span> IDENTIFIED BY <span class='s1'>&#39;monitor_password&#39;</span>;
Query OK, 0 rows affected <span class='o'>(</span>0.00 sec<span class='o'>)</span>

mysql&gt; GRANT SUPER, REPLICATION CLIENT, PROCESS ON *.* TO <span class='s1'>&#39;mmm_agent&#39;</span>@<span class='s1'>&#39;%&#39;</span> IDENTIFIED BY <span class='s1'>&#39;agent_password&#39;</span>;
Query OK, 0 rows affected <span class='o'>(</span>0.00 sec<span class='o'>)</span>

mysql&gt; GRANT REPLICATION SLAVE ON *.* TO <span class='s1'>&#39;replication&#39;</span>@<span class='s1'>&#39;%&#39;</span> IDENTIFIED BY <span class='s1'>&#39;replication_password&#39;</span>;
Query OK, 0 rows affected <span class='o'>(</span>0.00 sec<span class='o'>)</span>

mysql&gt; 


mysql&gt; flush privileges;
Query OK, 0 rows affected <span class='o'>(</span>0.01 sec<span class='o'>)</span>

mysql&gt; flush tables with <span class='nb'>read </span>lock;
Query OK, 0 rows affected <span class='o'>(</span>0.00 sec<span class='o'>)</span>




mysql&gt; show master status;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000001 |     1044 |              |                  |
+------------------+----------+--------------+------------------+
1 row in <span class='nb'>set</span> <span class='o'>(</span>0.00 sec<span class='o'>)</span>
</code></pre>
</div>
<h4 id='dont_close_this_session'>Dont Close this session</h4>

<p>dump database to master 2.</p>
<div class='highlight'><pre><code class='bash'><span class='c'># mysqldump -u root -p --all-databases &gt; /tmp/database-backup.sql</span>
<span class='c'># scp /tmp/database-backup.sql 111.68.112.44:~/</span>
</code></pre>
</div>
<h4 id='now_we_can_remove_lock_tables'>Now, we can remove lock tables</h4>
<div class='highlight'><pre><code class='bash'>mysql&gt; unlock tables;
Query OK, 0 rows affected <span class='o'>(</span>0.00 sec<span class='o'>)</span>
</code></pre>
</div>
<h4 id='go_to_master_2'>Go to Master 2</h4>

<h2 id='setup_master_2'>Setup Master 2</h2>
<div class='highlight'><pre><code class='bash'>root@srv15 mysql# mysql -u root -p &lt; /root/database-backup.sql 
Enter password: 

root@srv15 mysql# 
root@srv15 mysql# mysql -u root -p
Enter password: 
Welcome to the MySQL monitor.  Commands end with ; or <span class='se'>\g</span>.
Your MySQL connection id is 90
Server version: 5.5.12-log Source distribution

Copyright <span class='o'>(</span>c<span class='o'>)</span> 2000, 2010, Oracle and/or its affiliates. All rights reserved.

Oracle is a registered trademark of Oracle Corporation and/or its
affiliates. Other names may be trademarks of their respective
owners.

Type <span class='s1'>&#39;help;&#39;</span> or <span class='s1'>&#39;\h&#39;</span> <span class='k'>for </span>help. Type <span class='s1'>&#39;\c&#39;</span> to clear the current input statement.

mysql&gt; flush privileges;
Query OK, 0 rows affected <span class='o'>(</span>0.46 sec<span class='o'>)</span>

mysql&gt; CHANGE MASTER TO <span class='nv'>master_host</span><span class='o'>=</span><span class='s1'>&#39;111.68.112.43&#39;</span>, <span class='nv'>master_port</span><span class='o'>=</span>3306, <span class='nv'>master_user</span><span class='o'>=</span><span class='s1'>&#39;replication&#39;</span>, 
    -&gt;               <span class='nv'>master_password</span><span class='o'>=</span><span class='s1'>&#39;replication_password&#39;</span>, <span class='nv'>master_log_file</span><span class='o'>=</span><span class='s1'>&#39;mysql-bin.000001&#39;</span>, <span class='nv'>master_log_pos</span><span class='o'>=</span>1044;

Query OK, 0 rows affected <span class='o'>(</span>4.62 sec<span class='o'>)</span>

mysql&gt; 
mysql&gt; start slave;
Query OK, 0 rows affected <span class='o'>(</span>0.00 sec<span class='o'>)</span>

mysql&gt; show slave status <span class='se'>\G</span>
*************************** 1. row ***************************
               Slave_IO_State: Waiting <span class='k'>for </span>master to send event
                  Master_Host: 111.68.112.43
                  Master_User: replication
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000001
          Read_Master_Log_Pos: 1044
               Relay_Log_File: mysql-relay-bin.000002
                Relay_Log_Pos: 253
        Relay_Master_Log_File: mysql-bin.000001
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 1044
              Relay_Log_Space: 409
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 1
1 row in <span class='nb'>set</span> <span class='o'>(</span>0.00 sec<span class='o'>)</span>

mysql&gt; show master status
    -&gt; ;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000002 | 27957968 |              |                  |
+------------------+----------+--------------+------------------+
1 row in <span class='nb'>set</span> <span class='o'>(</span>0.00 sec<span class='o'>)</span>

mysql&gt; show master status;
+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000002 | 27957968 |              |                  |
+------------------+----------+--------------+------------------+
1 row in <span class='nb'>set</span> <span class='o'>(</span>0.00 sec<span class='o'>)</span>

root@srv15 mysql# 
</code></pre>
</div>
<h2 id='switch_back_to_master_1'>Switch Back to Master 1</h2>
<div class='highlight'><pre><code class='bash'>mysql&gt; CHANGE MASTER TO <span class='nv'>master_host</span><span class='o'>=</span><span class='s1'>&#39;111.68.112.44&#39;</span>, <span class='nv'>master_port</span><span class='o'>=</span>3306, <span class='nv'>master_user</span><span class='o'>=</span><span class='s1'>&#39;replication&#39;</span>, 
    -&gt;               <span class='nv'>master_password</span><span class='o'>=</span><span class='s1'>&#39;replication_password&#39;</span>, <span class='nv'>master_log_file</span><span class='o'>=</span><span class='s1'>&#39;mysql-bin.000002&#39;</span>, <span class='nv'>master_log_pos</span><span class='o'>=</span>27957968;
Query OK, 0 rows affected <span class='o'>(</span>0.34 sec<span class='o'>)</span>

mysql&gt; start slave;
Query OK, 0 rows affected <span class='o'>(</span>0.00 sec<span class='o'>)</span>

mysql&gt; show slave status<span class='se'>\G</span>
*************************** 1. row ***************************
               Slave_IO_State: Waiting <span class='k'>for </span>master to send event
                  Master_Host: 111.68.112.44
                  Master_User: replication
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysql-bin.000002
          Read_Master_Log_Pos: 27957968
               Relay_Log_File: mysql-relay-bin.000002
                Relay_Log_Pos: 253
        Relay_Master_Log_File: mysql-bin.000002
             Slave_IO_Running: Yes
            Slave_SQL_Running: Yes
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 27957968
              Relay_Log_Space: 409
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 2
1 row in <span class='nb'>set</span> <span class='o'>(</span>0.00 sec<span class='o'>)</span>

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| c4CkV893_B4r7Hue   |
| mysql              |
| performance_schema |
+--------------------+
4 rows in <span class='nb'>set</span> <span class='o'>(</span>0.00 sec<span class='o'>)</span>

mysql&gt; create database mmreplicate;
Query OK, 1 row affected <span class='o'>(</span>0.03 sec<span class='o'>)</span>

mysql&gt; <span class='se'>\q</span>
Bye
root@srv14 init.d#
</code></pre>
</div>
<h2 id='check_on_master_2'>Check on Master 2</h2>
<div class='highlight'><pre><code class='bash'>mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| c4CkV893_B4r7Hue   |
| mmreplicate        |
| mysql              |
| performance_schema |
+--------------------+
5 rows in <span class='nb'>set</span> <span class='o'>(</span>0.00 sec<span class='o'>)</span>

mysql&gt; <span class='se'>\q</span>
Bye
root@srv15 mysql# 
</code></pre>
</div>
<p><a href='http://mysql-mmm.org/mmm2:guide'>http://mysql-mmm.org/mmm2:guide</a></p>
</div>



<div id="disqus_thread"></div>

<script type="text/javascript" src="http://disqus.com/forums/buildsystem/embed.js">
</script>

<noscript>
    <p> <a href="http://nebansnotebook.disqus.com/?url=ref">View the discussion thread. </a> </p>
</noscript>



<div class="prevnext">
    
        <div class="prev">
            &laquo; <a href="/2011/08/14/compiling-mysql-5.5.12-with-cmake-on-centos.html"> Compiling MySQL 5.5.12 with CMAKE on CentOS </a>
        </div>
    

    
        <div class="next">
            <a href="/2011/08/17/load-balancing-mysql-replication-master-to-master-with-haproxy.html"> Load Balancing MySQL Replication Master to Master with HAProxy </a> &raquo;
        </div>
    
</div>




            </div>
            
<div class="footer">
   <center>
	<small>alinux.web.id, established since 2007, hosted by <a target="_new" href="http://tor.hu">tor.hu</a>, powered by <a target="_new" href="http://www.vim.org">vim</a> and <a target="_new" href="http://jekyllrb.com">jekyll</a><br/>
<a target="_new" href="https://github.com/deanet/alinux-documentation">source</a>
</small>
	</center>
</div>

            <div class="pageend"></div>
        </div>
    </div>
</body>
</html>

